<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåå Chuc Mung Sinh Nhat LKT </title>
    
    <style>
        @import "https://fonts.googleapis.com/css2?family=Megrim&display=swap";
        @import "https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;700&display=swap";

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            overflow: hidden;
            margin: 0;
            font-family: 'Quicksand', sans-serif;
            background: #000;
            cursor: grab;
        }

        body:active {
            cursor: grabbing;
        }

        /* Password Screen */
        #passwordScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a0011 0%, #1a0033 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            transition: opacity 1.5s ease;
        }

        #passwordScreen.fadeOut {
            opacity: 0;
            pointer-events: none;
        }

        .passwordContainer {
            text-align: center;
            padding: 40px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 204, 0, 0.3);
            animation: fadeInScale 1s ease;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .lockIcon {
            font-size: 60px;
            margin-bottom: 20px;
            animation: lockPulse 2s ease-in-out infinite;
        }

        @keyframes lockPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .passwordTitle {
            font-family: 'Megrim', cursive;
            font-size: 36px;
            color: #fc0;
            margin-bottom: 30px;
            -webkit-text-stroke: 1px #c0f;
        }

        .passwordInput {
            width: 300px;
            padding: 15px;
            font-size: 18px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #fc0;
            border-radius: 50px;
            color: #fff;
            text-align: center;
            letter-spacing: 2px;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .passwordInput:focus {
            outline: none;
            box-shadow: 0 0 20px rgba(255, 204, 0, 0.5);
            transform: scale(1.05);
        }

        .passwordInput::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .submitBtn {
            padding: 12px 40px;
            font-size: 16px;
            background: transparent;
            color: #fc0;
            border: 2px solid #fc0;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .submitBtn:hover {
            background: #fc0;
            color: #160016;
            transform: scale(1.05);
        }

        .passwordError {
            color: #ff4444;
            margin-top: 15px;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .passwordError.show {
            opacity: 1;
        }

        .passwordHint {
            margin-top: 20px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
        }

        /* Welcome Screen */
        #welcomeScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 2s ease;
        }

        #welcomeScreen.show {
            display: flex;
        }

        #welcomeScreen.fadeOut {
            opacity: 0;
            pointer-events: none;
        }

        .welcomeContent {
            text-align: center;
            animation: fadeInUp 1s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .galaxyTitle {
            font-family: 'Megrim', cursive;
            font-size: 100px;
            color: #fc0;
            -webkit-text-stroke: 2px #c0f;
            margin-bottom: 20px;
            animation: glow 2s ease-in-out infinite;
        }

        @keyframes glow {
            0%, 100% {
                text-shadow: 0 0 20px #c0f, 0 0 40px #c0f;
            }
            50% {
                text-shadow: 0 0 30px #c0f, 0 0 60px #c0f, 0 0 80px #fc0;
            }
        }

        .subtitle {
            color: rgba(255, 255, 255, 0.7);
            font-size: 18px;
            margin-bottom: 40px;
            letter-spacing: 2px;
        }

        .enterBtn {
            font-family: 'Megrim', cursive;
            font-size: 24px;
            padding: 15px 60px;
            background: transparent;
            color: #fc0;
            border: 2px solid #fc0;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 3px;
        }

        .enterBtn:hover:not(:disabled) {
            background: #fc0;
            color: #160016;
            box-shadow: 0 0 30px #fc0, inset 0 0 10px rgba(192, 15, 255, 0.3);
            transform: scale(1.05);
        }

        .enterBtn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            border-color: #666;
            color: #666;
        }

        /* Progress Bar */
        .progressContainer {
            margin-top: 30px;
            width: 400px;
            max-width: 90%;
        }

        .progressBar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progressFill {
            height: 100%;
            background: linear-gradient(90deg, #fc0, #c0f);
            width: 0%;
            transition: width 0.3s ease;
            box-shadow: 0 0 10px #fc0;
        }

        .progressText {
            color: #fc0;
            font-size: 14px;
            letter-spacing: 1px;
        }

        .loadingIcon {
            display: inline-block;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Galaxy Container */
        #galaxyContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 3s ease;
        }

        #galaxyContainer.show {
            opacity: 1;
        }

        /* Central Star */
        #centralStar {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100px;
            height: 100px;
            opacity: 0;
            transition: opacity 2s ease;
            cursor: pointer;
            z-index: 100;
        }

        #centralStar.show {
            opacity: 1;
            animation: starPulse 2s ease-in-out infinite;
        }

        @keyframes starPulse {
            0%, 100% {
                transform: translate(-50%, -50%) scale(1);
            }
            50% {
                transform: translate(-50%, -50%) scale(1.2);
            }
        }

        .starCore {
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, #fff 0%, #fc0 30%, #e39b00 60%, transparent 70%);
            border-radius: 50%;
            box-shadow: 0 0 60px #fc0, 0 0 100px #fc0;
        }

        .starHint {
            position: absolute;
            bottom: -40px;
            left: 50%;
            transform: translateX(-50%);
            color: #fc0;
            font-size: 12px;
            letter-spacing: 2px;
            white-space: nowrap;
            animation: blink 2s ease-in-out infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        /* Birthday Message */
        #birthdayMessage {
            position: fixed;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            opacity: 0;
            pointer-events: none;
            z-index: 200;
            transition: opacity 2s ease;
        }

        #birthdayMessage.show {
            opacity: 1;
        }

        .birthdayTitle {
            font-family: 'Megrim', cursive;
            font-size: 60px;
            color: #fc0;
            -webkit-text-stroke: 1.5px #c0f;
            margin-bottom: 10px;
            animation: titleFloat 3s ease-in-out infinite;
            text-shadow: 0 0 30px rgba(255, 204, 0, 0.8);
        }

        @keyframes titleFloat {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        /* Controls */
        .controls {
            position: fixed;
            bottom: 30px;
            right: 30px;
            display: flex;
            gap: 15px;
            z-index: 300;
        }

        .controlBtn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(22, 0, 22, 0.8);
            border: 2px solid #fc0;
            color: #fc0;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .controlBtn:hover {
            background: #fc0;
            color: #160016;
            transform: scale(1.1);
        }

        .controlBtn.active {
            background: #fc0;
            color: #160016;
        }

        /* Instructions */
        .instructions {
            position: fixed;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 20px;
            color: #fc0;
            font-size: 14px;
            letter-spacing: 1px;
            backdrop-filter: blur(10px);
            z-index: 300;
        }

        /* Particle Counter */
        .particleCounter {
            position: fixed;
            bottom: 30px;
            left: 30px;
            background: rgba(22, 0, 22, 0.8);
            padding: 10px 20px;
            border-radius: 25px;
            border: 1px solid #fc0;
            backdrop-filter: blur(10px);
            color: #fc0;
            font-family: 'Megrim', cursive;
            font-size: 18px;
            letter-spacing: 2px;
        }

        /* Confetti */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #fc0;
            pointer-events: none;
            z-index: 1000;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .galaxyTitle { font-size: 60px; }
            .birthdayTitle { font-size: 36px; }
            .enterBtn { padding: 12px 40px; font-size: 18px; }
            .controlBtn { width: 40px; height: 40px; font-size: 16px; }
            .passwordInput { width: 250px; }
            .passwordTitle { font-size: 28px; }
            .progressContainer { width: 300px; }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
    </style>
</head>
<body>
    <!-- Password Screen -->
    <div id="passwordScreen">
        <div class="passwordContainer">
            <div class="lockIcon">üîí</div>
            <h2 class="passwordTitle">ENTER PASSWORD</h2>
            <input type="password" 
                   id="passwordInput" 
                   class="passwordInput" 
                   placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                   onkeypress="handlePasswordKeyPress(event)">
            <button class="submitBtn" onclick="checkPassword()">X√ÅC NH·∫¨N</button>
            <div class="passwordError" id="passwordError">M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!</div>
            <div class="passwordHint">Hint: Ng√†y sinh nh·∫≠t c·ªßa b·∫°n</div>
        </div>
    </div>

    <!-- Welcome Screen -->
    <div id="welcomeScreen">
        <div class="welcomeContent">
            <h1 class="galaxyTitle">CH√öC M·ª™NG NƒÇM M·ªöI (( </h1>
            <p class="subtitle">V·∫´n l√† ch√∫c m·ª´ng nƒÉm m·ªõi ((</p>
            
            <!-- Progress Container -->
            <div class="progressContainer" id="progressContainer" style="display: none;">
                <div class="progressBar">
                    <div class="progressFill" id="progressFill"></div>
                </div>
                <div class="progressText" id="progressText">
                    <span class="loadingIcon">‚è≥</span>
                    ƒêang t·∫£i ·∫£nh... <span id="progressCount">0/13</span>
                </div>
            </div>
            
            <button class="enterBtn" id="enterBtn" onclick="enterGalaxy()" disabled>ƒêANG T·∫¢I...</button>
        </div>
    </div>

    <!-- Galaxy Container -->
    <div id="galaxyContainer"></div>

    <!-- Central Star -->
    <div id="centralStar" onclick="onStarClick()">
        <div class="starCore"></div>
        <div class="starHint">Click v√†o ƒë√¢y</div>
    </div>

    <!-- Birthday Message -->
    <div id="birthdayMessage">
        <h1 class="birthdayTitle">üéÇ Happy Birthday LKT üéÇ ((: </h1>
    </div>

    <!-- Instructions -->
    <div class="instructions" style="display: none;" id="instructions">
        üñ±Ô∏è K√©o ƒë·ªÉ xoay ‚Ä¢ Cu·ªôn ƒë·ªÉ zoom ‚Ä¢ Click ng√¥i sao trung t√¢m
    </div>

    <!-- Controls -->
    <div class="controls">
        <button class="controlBtn" id="musicBtn" onclick="toggleMusic()">üéµ</button>
        <button class="controlBtn active" id="rotateBtn" onclick="toggleRotation()">üîÑ</button>
        <button class="controlBtn" onclick="toggleFullscreen()">‚õ∂</button>
    </div>

    <!-- Particle Counter -->
    <div class="particleCounter">
        <span id="particleCount">0</span> particles
    </div>

    <!-- Audio -->
    <audio id="bgMusic" loop>
        <source src="music.mp3" type="audio/mpeg">
    </audio>

    <script type="module">
        import * as THREE from "https://cdn.skypack.dev/three@0.136.0";
        import { OrbitControls } from "https://cdn.skypack.dev/three@0.136.0/examples/jsm/controls/OrbitControls";

        // ==================== C·∫§U H√åNH ====================
        const PASSWORD = "16112003";

        const IMAGE_URLS = [
            "https://raw.githubusercontent.com/Minhsdasdasda/LKT/refs/heads/main/9.jpg",
            "https://raw.githubusercontent.com/Minhsdasdasda/LKT/refs/heads/main/2.jpg",
            "https://raw.githubusercontent.com/Minhsdasdasda/LKT/refs/heads/main/3.jpg",
            "https://raw.githubusercontent.com/Minhsdasdasda/LKT/refs/heads/main/4.jpg",
            "https://raw.githubusercontent.com/Minhsdasdasda/LKT/refs/heads/main/5.jpg",
            "https://raw.githubusercontent.com/Minhsdasdasda/LKT/refs/heads/main/6.jpg",
            "https://raw.githubusercontent.com/Minhsdasdasda/LKT/refs/heads/main/7.jpg",
            "https://raw.githubusercontent.com/Minhsdasdasda/LKT/refs/heads/main/8.jpg",
            "https://raw.githubusercontent.com/Minhsdasdasda/LKT/refs/heads/main/1.jpg",
            "https://raw.githubusercontent.com/Minhsdasdasda/LKT/refs/heads/main/10.jpg",
            "https://raw.githubusercontent.com/Minhsdasdasda/LKT/refs/heads/main/3.jpg",
            "https://raw.githubusercontent.com/Minhsdasdasda/LKT/refs/heads/main/5.jpg",
            "https://raw.githubusercontent.com/Minhsdasdasda/LKT/refs/heads/main/1.jpg"
        ];

        const WISHES = [
            "üéÇ Ch√∫c m·ª´ng sinh nh·∫≠t",
            "‚ú® Tu·ªïi m·ªõi h·∫°nh ph√∫c",
            "üåü M·ªçi ƒëi·ªÅu t·ªët l√†nh",
            "üí´ Th√†nh c√¥ng r·ª±c r·ª°",
            "üéâ Ni·ªÅm vui tr·ªçn v·∫πn",
            "üíñ Y√™u th∆∞∆°ng ng·∫≠p tr√†n",
            "üåà Mong g√¨ ƒë∆∞·ª£c ƒë√≥",
            "üéä S·ª©c kh·ªèe d·ªìi d√†o",
            "‚≠ê Lu√¥n t·ªèa s√°ng",
            "üå∫ Xinh ƒë·∫πp m√£i m√£i",
            "üéÅ Nhi·ªÅu ƒëi·ªÅu b·∫•t ng·ªù",
            "üå∏ Thanh xu√¢n r·ª±c r·ª°",
            "üíù Y√™u th∆∞∆°ng v√¥ b·ªù",
            "üå∑ Hoa n·ªü tr√™n ƒë∆∞·ªùng ƒë·ªùi",
            "üéà Vui v·∫ª m·ªói ng√†y"
        ];

        // ==================== GLOBAL VARIABLES ====================
        let scene, camera, renderer, controls;
        let galaxyPoints, startTime;
        let isRotating = true;
        let particlePositions = [];
        let targetPositions = [];
        let isForming = false;
        let formationProgress = 0;
        let orbitalElements = [];
        let wishesCreatedCount = 0;

        // ‚≠ê CACHE ·∫¢NH ƒê√É LOAD
        const loadedTextures = [];
        let allImagesLoaded = false;

        // ==================== PRELOAD IMAGES ====================
        function preloadImages() {
            console.log('üöÄ B·∫Øt ƒë·∫ßu preload ·∫£nh...');
            
            // Hi·ªÉn th·ªã progress
            document.getElementById('progressContainer').style.display = 'block';
            
            const textureLoader = new THREE.TextureLoader();
            textureLoader.setCrossOrigin('anonymous');
            
            let loadedCount = 0;
            const totalImages = IMAGE_URLS.length;
            
            const loadPromises = IMAGE_URLS.map((url, index) => {
                return new Promise((resolve, reject) => {
                    textureLoader.load(
                        url,
                        (texture) => {
                            // L∆∞u texture v√†o cache
                            loadedTextures[index] = texture;
                            loadedCount++;
                            
                            // C·∫≠p nh·∫≠t progress
                            const percent = (loadedCount / totalImages) * 100;
                            document.getElementById('progressFill').style.width = percent + '%';
                            document.getElementById('progressCount').textContent = `${loadedCount}/${totalImages}`;
                            
                            console.log(`‚úÖ Loaded ${loadedCount}/${totalImages}: ${url.substring(0, 50)}...`);
                            
                            resolve(texture);
                        },
                        (progress) => {
                            // Loading progress
                        },
                        (error) => {
                            console.error(`‚ùå Failed to load image ${index}:`, error);
                            
                            // T·∫°o fallback texture
                            const canvas = document.createElement('canvas');
                            canvas.width = 256;
                            canvas.height = 256;
                            const ctx = canvas.getContext('2d');
                            
                            const gradient = ctx.createLinearGradient(0, 0, 256, 256);
                            gradient.addColorStop(0, `hsl(${Math.random()*360}, 70%, 50%)`);
                            gradient.addColorStop(1, `hsl(${Math.random()*360}, 70%, 30%)`);
                            ctx.fillStyle = gradient;
                            ctx.fillRect(0, 0, 256, 256);
                            
                            ctx.fillStyle = '#fff';
                            ctx.font = 'bold 20px Arial';
                            ctx.textAlign = 'center';
                            ctx.fillText('üñºÔ∏è', 128, 128);
                            
                            const fallbackTexture = new THREE.CanvasTexture(canvas);
                            loadedTextures[index] = fallbackTexture;
                            loadedCount++;
                            
                            const percent = (loadedCount / totalImages) * 100;
                            document.getElementById('progressFill').style.width = percent + '%';
                            document.getElementById('progressCount').textContent = `${loadedCount}/${totalImages}`;
                            
                            resolve(fallbackTexture);
                        }
                    );
                });
            });
            
            // Ch·ªù t·∫•t c·∫£ ·∫£nh load xong
            Promise.all(loadPromises).then(() => {
                console.log('‚úÖ T·∫•t c·∫£ ·∫£nh ƒë√£ ƒë∆∞·ª£c t·∫£i!');
                allImagesLoaded = true;
                
                // Enable n√∫t kh√°m ph√°
                const enterBtn = document.getElementById('enterBtn');
                enterBtn.disabled = false;
                enterBtn.textContent = 'XEM';
                enterBtn.style.animation = 'glow 2s ease-in-out infinite';
                
                // ·∫®n progress sau 1s
                setTimeout(() => {
                    document.getElementById('progressContainer').style.display = 'none';
                }, 1000);
            });
        }

        // ==================== PASSWORD FUNCTIONS ====================
        window.handlePasswordKeyPress = function(event) {
            if(event.key === 'Enter') {
                checkPassword();
            }
        };

        window.checkPassword = function() {
            const input = document.getElementById('passwordInput');
            const error = document.getElementById('passwordError');
            
            if(input.value === PASSWORD) {
                document.getElementById('passwordScreen').classList.add('fadeOut');
                
                setTimeout(() => {
                    document.getElementById('passwordScreen').style.display = 'none';
                    document.getElementById('welcomeScreen').classList.add('show');
                    
                    // ‚≠ê B·∫ÆT ƒê·∫¶U PRELOAD ·∫¢NH NGAY SAU KHI NH·∫¨P ƒê√öNG M·∫¨T KH·∫®U
                    preloadImages();
                }, 1500);
            } else {
                error.classList.add('show');
                input.value = '';
                input.style.animation = 'shake 0.5s';
                
                setTimeout(() => {
                    input.style.animation = '';
                    error.classList.remove('show');
                }, 2000);
            }
        };

        // ==================== ENTER GALAXY ====================
        window.enterGalaxy = function() {
            if(!allImagesLoaded) {
                alert('Vui l√≤ng ƒë·ª£i ·∫£nh t·∫£i xong!');
                return;
            }
            
            const music = document.getElementById('bgMusic');
            music.volume = 0.3;
            music.play().catch(e => console.log('Autoplay prevented'));

            document.getElementById('welcomeScreen').classList.add('fadeOut');
            
            setTimeout(() => {
                document.getElementById('welcomeScreen').style.display = 'none';
                document.getElementById('galaxyContainer').classList.add('show');
                document.getElementById('instructions').style.display = 'block';
                
                initGalaxy();
                
                setTimeout(() => {
                    document.getElementById('centralStar').classList.add('show');
                }, 5000);
            }, 2000);
        };

        // ==================== INIT GALAXY ====================
        function initGalaxy() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x160016);
            
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 1, 1000);
            camera.position.set(0, 4, 21);
            
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('galaxyContainer').appendChild(renderer.domElement);
            
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(ambientLight);
            
            const pointLight = new THREE.PointLight(0xffd700, 2, 100);
            pointLight.position.set(0, 0, 0);
            scene.add(pointLight);
            
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.enablePan = false;
            controls.autoRotate = isRotating;
            controls.autoRotateSpeed = 0.5;
            controls.minDistance = 5;
            controls.maxDistance = 100;

            window.addEventListener("resize", () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });

            createAnimatedGalaxy();
            
            setTimeout(() => {
                createOrbitalElements();
            }, 3000);
        }

        function createAnimatedGalaxy() {
            const gu = { time: { value: 0 } };
            const sizes = [];
            const shift = [];
            
            const pushShift = () => {
                shift.push(
                    Math.random() * Math.PI,
                    Math.random() * Math.PI * 2,
                    (Math.random() * 0.9 + 0.1) * Math.PI * 0.1,
                    Math.random() * 0.9 + 0.1
                );
            };

            const totalParticles = 150000;
            const pts = [];
            
            for(let i = 0; i < 50000; i++) {
                const startPos = new THREE.Vector3(
                    (Math.random() - 0.5) * 100,
                    (Math.random() - 0.5) * 100,
                    (Math.random() - 0.5) * 100
                );
                
                const targetPos = new THREE.Vector3().randomDirection()
                    .multiplyScalar(Math.random() * 0.5 + 9.5);
                
                particlePositions.push(startPos);
                targetPositions.push(targetPos);
                pts.push(startPos.clone());
                
                sizes.push(Math.random() * 1.5 + 0.5);
                pushShift();
            }
            
            for(let i = 0; i < 100000; i++) {
                let r = 10, R = 40;
                let rand = Math.pow(Math.random(), 1.5);
                let radius = Math.sqrt(R * R * rand + (1 - rand) * r * r);
                
                const startPos = new THREE.Vector3(
                    (Math.random() - 0.5) * 200,
                    (Math.random() - 0.5) * 200,
                    (Math.random() - 0.5) * 200
                );
                
                const targetPos = new THREE.Vector3().setFromCylindricalCoords(
                    radius, 
                    Math.random() * 2 * Math.PI, 
                    (Math.random() - 0.5) * 2
                );
                
                particlePositions.push(startPos);
                targetPositions.push(targetPos);
                pts.push(startPos.clone());
                
                sizes.push(Math.random() * 1.5 + 0.5);
                pushShift();
            }

            document.getElementById('particleCount').textContent = totalParticles.toLocaleString();

            const geometry = new THREE.BufferGeometry().setFromPoints(pts);
            geometry.setAttribute("sizes", new THREE.Float32BufferAttribute(sizes, 1));
            geometry.setAttribute("shift", new THREE.Float32BufferAttribute(shift, 4));
            
            const material = new THREE.PointsMaterial({
                size: 0.125,
                transparent: true,
                depthTest: false,
                blending: THREE.AdditiveBlending,
                onBeforeCompile: shader => {
                    shader.uniforms.time = gu.time;
                    shader.vertexShader = `
                        uniform float time;
                        attribute float sizes;
                        attribute vec4 shift;
                        varying vec3 vColor;
                        ${shader.vertexShader}
                    `.replace(
                        `gl_PointSize = size;`,
                        `gl_PointSize = size * sizes;`
                    ).replace(
                        `#include <color_vertex>`,
                        `#include <color_vertex>
                        float d = length(abs(position) / vec3(40., 10., 40));
                        d = clamp(d, 0., 1.);
                        vColor = mix(vec3(227., 155., 0.), vec3(100., 50., 255.), d) / 255.;`
                    ).replace(
                        `#include <begin_vertex>`,
                        `#include <begin_vertex>
                        float t = time;
                        float moveT = mod(shift.x + shift.z * t, PI2);
                        float moveS = mod(shift.y + shift.z * t, PI2);
                        transformed += vec3(cos(moveS) * sin(moveT), cos(moveT), sin(moveS) * sin(moveT)) * shift.a;`
                    );
                    
                    shader.fragmentShader = `
                        varying vec3 vColor;
                        ${shader.fragmentShader}
                    `.replace(
                        `#include <clipping_planes_fragment>`,
                        `#include <clipping_planes_fragment>
                        float d = length(gl_PointCoord.xy - 0.5);`
                    ).replace(
                        `vec4 diffuseColor = vec4( diffuse, opacity );`,
                        `vec4 diffuseColor = vec4( vColor, smoothstep(0.5, 0.1, d) );`
                    );
                }
            });

            galaxyPoints = new THREE.Points(geometry, material);
            galaxyPoints.rotation.order = "ZYX";
            galaxyPoints.rotation.z = 0.2;
            scene.add(galaxyPoints);

            isForming = true;
            startTime = Date.now();

            const clock = new THREE.Clock();
            
            renderer.setAnimationLoop(() => {
                controls.update();
                
                const t = clock.getElapsedTime() * 0.5;
                gu.time.value = t * Math.PI;
                
                if(isForming) {
                    const elapsed = Date.now() - startTime;
                    formationProgress = Math.min(elapsed / 5000, 1);
                    
                    const positions = geometry.attributes.position.array;
                    for(let i = 0; i < particlePositions.length; i++) {
                        const i3 = i * 3;
                        const start = particlePositions[i];
                        const target = targetPositions[i];
                        
                        const progress = easeInOutCubic(formationProgress);
                        
                        positions[i3] = start.x + (target.x - start.x) * progress;
                        positions[i3 + 1] = start.y + (target.y - start.y) * progress;
                        positions[i3 + 2] = start.z + (target.z - start.z) * progress;
                    }
                    geometry.attributes.position.needsUpdate = true;
                    
                    if(formationProgress >= 1) {
                        isForming = false;
                    }
                }
                
                if(isRotating) {
                    galaxyPoints.rotation.y = t * 0.05;
                }
                
                updateOrbitalElements(t);
                
                renderer.render(scene, camera);
            });
        }

        // ==================== CREATE ORBITAL ELEMENTS ====================
        function createOrbitalElements() {
            console.log('üåü T·∫°o orbital elements t·ª´ cache...');
            
            // Create wishes
            const duplicatedWishes = [];
            WISHES.forEach(wish => {
                const copies = 4 + Math.floor(Math.random() * 3);
                for(let i = 0; i < copies; i++) {
                    duplicatedWishes.push(wish);
                }
            });
            
            duplicatedWishes.sort(() => Math.random() - 0.5);
            
            duplicatedWishes.forEach((wish, index) => {
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.width = 512;
                canvas.height = 128;
                
                context.font = 'Bold 40px Megrim';
                context.fillStyle = '#fc0';
                context.strokeStyle = '#c0f';
                context.lineWidth = 2;
                context.textAlign = 'center';
                context.textBaseline = 'middle';
                context.fillText(wish, 256, 64);
                context.strokeText(wish, 256, 64);
                
                const texture = new THREE.CanvasTexture(canvas);
                const spriteMaterial = new THREE.SpriteMaterial({ 
                    map: texture,
                    transparent: true,
                    opacity: 0.9,
                    depthWrite: false
                });
                
                const sprite = new THREE.Sprite(spriteMaterial);
                sprite.scale.set(8, 2, 1);
                
                const angle = (index / duplicatedWishes.length) * Math.PI * 2 * 3;
                const radius = 10 + (index / duplicatedWishes.length) * 30;
                const height = (Math.random() - 0.5) * 4;
                
                orbitalElements.push({
                    mesh: sprite,
                    baseRadius: radius,
                    angle: angle,
                    height: height,
                    speed: 0.001 + Math.random() * 0.001,
                    spiralSpeed: 0.02,
                    type: 'text'
                });
                
                scene.add(sprite);
                wishesCreatedCount++;
            });
            
            console.log(`‚úÖ Created ${wishesCreatedCount} wishes`);
            
            // ‚≠ê S·ª¨ D·ª§NG TEXTURES ƒê√É LOAD T·ª™ CACHE
            const duplicatedPhotos = [];
            loadedTextures.forEach((texture, index) => {
                const copies = 3;
                for(let i = 0; i < copies; i++) {
                    duplicatedPhotos.push({ texture, index });
                }
            });
            
            duplicatedPhotos.sort(() => Math.random() - 0.5);
            
            console.log(`üì∏ T·∫°o ${duplicatedPhotos.length} photo t·ª´ ${loadedTextures.length} textures ƒë√£ load`);
            
            duplicatedPhotos.forEach((photoData, index) => {
                const geometry = new THREE.PlaneGeometry(1.9, 1.9);
                const material = new THREE.MeshBasicMaterial({
                    map: photoData.texture, // S·ª¨ D·ª§NG TEXTURE ƒê√É LOAD
                    side: THREE.DoubleSide,
                    transparent: true,
                    opacity: 0.95
                });
                
                const photoMesh = new THREE.Mesh(geometry, material);
                
                const angle = (index / duplicatedPhotos.length) * Math.PI * 2 * 4;
                const radius = 8 + (index / duplicatedPhotos.length) * 35;
                const height = (Math.random() - 0.5) * 3;
                
                orbitalElements.push({
                    mesh: photoMesh,
                    baseRadius: radius,
                    angle: angle,
                    height: height,
                    speed: 0.0005 + Math.random() * 0.001,
                    spiralSpeed: 0.015,
                    type: 'photo'
                });
                
                scene.add(photoMesh);
            });
            
            console.log(`üåü Total elements: ${orbitalElements.length}`);
        }

        function updateOrbitalElements(time) {
            orbitalElements.forEach(element => {
                const spiralAngle = element.angle + time * element.speed;
                const spiralRadius = element.baseRadius + Math.sin(spiralAngle * element.spiralSpeed) * 2;
                
                element.mesh.position.x = Math.cos(spiralAngle) * spiralRadius;
                element.mesh.position.y = element.height + Math.sin(time * 2) * 0.5;
                element.mesh.position.z = Math.sin(spiralAngle) * spiralRadius;
                
                if(element.type === 'text') {
                    element.mesh.lookAt(camera.position);
                } else {
                    element.mesh.lookAt(camera.position);
                    element.mesh.rotation.z += Math.sin(spiralAngle * 2) * 0.02;
                }
                
                const distance = element.mesh.position.distanceTo(camera.position);
                const scaleFactor = Math.max(0.5, Math.min(2, 30 / distance));
                
                if(element.type === 'photo') {
                    element.mesh.scale.set(scaleFactor * 1.9, scaleFactor * 1.9, 1);
                } else {
                    element.mesh.scale.set(scaleFactor * 8, scaleFactor * 2, 1);
                }
                
                const opacity = Math.max(0.5, Math.min(1, 40 / distance));
                if(element.mesh.material) {
                    element.mesh.material.opacity = opacity;
                }
            });
        }

        function easeInOutCubic(t) {
            return t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
        }

        // ==================== STAR CLICK ====================
        window.onStarClick = function() {
            document.getElementById('centralStar').style.display = 'none';
            document.getElementById('instructions').style.display = 'none';
            
            setTimeout(() => {
                document.getElementById('birthdayMessage').classList.add('show');
                createConfetti();
            }, 1000);
        };

        function createConfetti() {
            const colors = ['#fc0', '#c0f', '#e39b00', '#fff'];
            
            for(let i = 0; i < 100; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.left = Math.random() * window.innerWidth + 'px';
                confetti.style.top = '-10px';
                document.body.appendChild(confetti);
                
                let posY = -10;
                const velocityY = Math.random() * 5 + 3;
                const velocityX = (Math.random() - 0.5) * 2;
                let posX = parseFloat(confetti.style.left);
                
                const fall = setInterval(() => {
                    posY += velocityY;
                    posX += velocityX;
                    confetti.style.top = posY + 'px';
                    confetti.style.left = posX + 'px';
                    confetti.style.transform = `rotate(${posY * 2}deg)`;
                    
                    if(posY > window.innerHeight) {
                        clearInterval(fall);
                        confetti.remove();
                    }
                }, 20);
            }
        }

        // ==================== CONTROLS ====================
        window.toggleMusic = function() {
            const music = document.getElementById('bgMusic');
            const btn = document.getElementById('musicBtn');
            
            if(music.paused) {
                music.play();
                btn.classList.add('active');
            } else {
                music.pause();
                btn.classList.remove('active');
            }
        };

        window.toggleRotation = function() {
            isRotating = !isRotating;
            const btn = document.getElementById('rotateBtn');
            
            if(controls) {
                controls.autoRotate = isRotating;
            }
            
            if(isRotating) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        };

        window.toggleFullscreen = function() {
            if(!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        };
    </script>
</body>
</html>